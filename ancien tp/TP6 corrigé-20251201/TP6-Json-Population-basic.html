<!doctype html>
<html lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>TP5 Population</title>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<style type="text/css">
body{
  font-family:Verdana, Geneva, sans-serif;
  background-color:#b2bdc6;
} 

table {
  border:3px solid #6495ed;
  border-collapse:collapse;
  width:50%;
  margin:auto;
}

tbody {
  background-color:#FFFFFF;
  border:1px solid #6495ed;
}

th {
  padding:5px;
  background-color:#EFF6FF;
  width:25%;
}

td{
  font-family:sans-serif;
  font-size:80%;
  border:1px solid #6495ed;
  padding:5px;
  text-align:center;
}

</style>

<script>
var vRequete; // objet XMLHttpRequest global

function rest(){
    var departement = document.getElementById('departement').value;
    var adresse = 'https://geo.api.gouv.fr/departements/' + departement + '/communes';
    vRequete = new XMLHttpRequest();
    vRequete.onreadystatechange = gestion_requete;
    vRequete.open('GET', adresse);
    vRequete.send();
}

function gestion_requete() {
    if (vRequete.readyState === XMLHttpRequest.DONE) {
        if (vRequete.status === 200) {
            var donne = vRequete.responseText;
            var donnees = JSON.parse(donne);

            // tri décroissant par population
            donnees.sort(function(a,b){ return b.population - a.population; });

            document.getElementById("rendu").innerHTML = '';
            var popu_globale = 0;

            var vPop = []; // tableau pour D3
            var vCom = []; // tableau des noms (pour l'étape suivante)

            for (var i = 0; i < donnees.length; i++) {
                if (donnees[i].population > 3000) {
                    var nouvelleLigne = document.getElementById("rendu").insertRow(-1);

                    var nouvelleCellule = nouvelleLigne.insertCell(-1);
                    nouvelleCellule.textContent = donnees[i].nom;

                    nouvelleCellule = nouvelleLigne.insertCell(-1);
                    nouvelleCellule.textContent = i+1;

                    nouvelleCellule = nouvelleLigne.insertCell(-1);
                    nouvelleCellule.textContent = donnees[i].codesPostaux;

                    nouvelleCellule = nouvelleLigne.insertCell(-1);
                    nouvelleCellule.textContent = donnees[i].population;

                    popu_globale += donnees[i].population;

                    // ajout pour D3
                    vPop.push(donnees[i].population);
                    vCom.push(donnees[i].nom);
                }
            }

            document.getElementById("popu_globale").value = popu_globale;

            // appel du graphique
            graph_population(vPop);
        } else {
            alert('Problème de requête.');
        }
    }
}

// Fonction pour créer le graphique à barres (Étape 1)
// Fonction pour créer un graphique à barres des populations
// @param vPop : tableau contenant les valeurs de population à afficher
function graph_population(vPop) {
    
    // ========== NETTOYAGE ET INITIALISATION ==========
    
    // Sélectionne le conteneur #graphique et supprime tout son contenu
    // Permet d'effacer le graphique précédent avant d'en créer un nouveau
    d3.select("#graphique").selectAll("*").remove();
    
    // Définition des dimensions du graphique
    var width = 500;   // Largeur totale en pixels
    var height = 300;  // Hauteur totale en pixels
    
    // Marges pour laisser de l'espace aux axes et étiquettes
    var margin = {top: 20, right: 20, bottom: 30, left: 40};
    
    
    // ========== CRÉATION DU CANVAS SVG ==========
    
    // Sélectionne le div #graphique et y ajoute un élément SVG
    var svg = d3.select("#graphique")
                .append("svg")                    // Crée un élément <svg>
                .attr("width", width)             // Définit la largeur
                .attr("height", height);          // Définit la hauteur
    
    
    // ========== ÉCHELLES (SCALES) ==========
    
    // Échelle Y (verticale) : convertit les valeurs de population en coordonnées pixels
    var y = d3.scaleLinear()
              .domain([0, d3.max(vPop)])          // Domaine : de 0 à la population max
              .range([height - margin.bottom, margin.top]);  // Plage : du bas vers le haut (inversé car SVG commence en haut)
    
    // Échelle X (horizontale) : positionne les barres côte à côte
    var x = d3.scaleBand()
              .domain(d3.range(vPop.length))      // Domaine : indices [0, 1, 2, ...]
              .range([margin.left, width - margin.right])  // Plage : de la marge gauche à la marge droite
              .padding(0.1);                      // Espacement de 10% entre les barres
    
    
    // ========== DESSIN DES BARRES ==========
    
    svg.selectAll("rect")                         // Sélectionne tous les rectangles (vide au départ)
       .data(vPop)                                // Lie les données du tableau vPop
       .enter()                                   // Pour chaque élément de données sans rectangle correspondant
       .append("rect")                            // Crée un nouveau rectangle <rect>
       .attr("x", (d,i) => x(i))                  // Position X : utilise l'échelle x avec l'indice i
       .attr("y", d => y(d))                      // Position Y : utilise l'échelle y avec la valeur de population d
       .attr("height", d => height - margin.bottom - y(d))  // Hauteur : distance entre le bas et y(d)
       .attr("width", x.bandwidth())              // Largeur : largeur automatique calculée par l'échelle
       .attr("fill", "#6495ed");                  // Couleur de remplissage : bleu cornflower
    
    
    // ========== ÉTIQUETTES DE VALEURS ==========
    
    svg.selectAll("text")                         // Sélectionne tous les textes (vide au départ)
       .data(vPop)                                // Lie les données du tableau vPop
       .enter()                                   // Pour chaque élément de données
       .append("text")                            // Crée un élément <text>
       .attr("x", (d,i) => x(i) + x.bandwidth()/2)  // Position X : centre de la barre
       .attr("y", d => y(d) - 5)                  // Position Y : 5 pixels au-dessus de la barre
       .attr("text-anchor", "middle")             // Ancrage au centre pour centrer le texte
       .text(d => d);                             // Contenu du texte : la valeur de population
    
    
    // ========== AXE X (HORIZONTAL - BAS) ==========
    
    svg.append("g")                               // Crée un groupe <g> pour l'axe
       .attr("transform", `translate(0,${height - margin.bottom})`)  // Déplace le groupe au bas du graphique (270px)
       .call(d3.axisBottom(x)                     // Génère un axe horizontal en bas
             .tickFormat(i => i+1));              // Format des graduations : affiche 1, 2, 3... au lieu de 0, 1, 2...
    
    
    // ========== AXE Y (VERTICAL - GAUCHE) ==========
    
    svg.append("g")                               // Crée un groupe <g> pour l'axe
       .attr("transform", `translate(${margin.left},0)`)  // Déplace le groupe à gauche (40px de la bordure)
       .call(d3.axisLeft(y));                     // Génère un axe vertical à gauche avec les valeurs de population
}
</script>
</head>

<body>

<button onclick="rest()">API population</button>
<input type="text" id="departement" placeholder="Numéro département"/>
<br><br>
<input type="text" id="popu_globale" placeholder="Population globale"/>

<table>
    <thead>
        <tr>
            <th>Ville</th>
            <th>Classement</th>
            <th>Code postal</th>
            <th>Population</th>
        </tr>
    </thead>
    <tbody id="rendu"></tbody>
</table>

<!-- Conteneur pour D3.js -->
<div id="graphique" style="width: 600px; margin:auto; margin-top:20px;"></div>

</body>
</html>
