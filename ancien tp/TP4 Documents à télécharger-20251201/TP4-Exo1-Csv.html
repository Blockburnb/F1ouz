<!DOCTYPE html>
<html>
<head>
    <title>CSV to JSON Converter</title>
</head>
<body>
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="convertCSVtoJSON()">Convert to JSON</button>
    <!-- Q2-b: Ajout balise p en dessosu-->
    <p id="myp" style="color: blue"> Liste des utilisateurs </p>

    <script>
        //Fonction qui va ouvrir une fenêtre afin de parcourir le PC et chercher le fichier Json
        function convertCSVtoJSON() {
        const csvFile = document.getElementById('csvFile').files[0];
        if (!csvFile) {
            alert('Please select a CSV file.');
            return;
        }

        const reader = new FileReader();
        reader.readAsText(csvFile);

        reader.onload = function (e) {
            //Récupération dans une variable du résultat du vReader
            const csvText = e.target.result;
            /* Contrairement à un fichier JSON on ne peut transformer 
             * directement le contenu d'un fichier CSV et objet JSON. 
             * On doit faire un traitement préalable*/

            //On recupère un tableau de ligne 
            lines= csvText.split('\n')               //\n indique la fin d'une ligne
                .map(line => line.trim())            //Enlève les espace superflux au début et à la fin
                .filter(line => line.length > 0);    //Enlève les lignes vides

            //On récupère la première ligne qui est l'entête
            const entete = lines[0];

            /*Chaque ligne contient des chaines de craactères separée par des ";"
             * On recupère un table de mot pour chaque ligne. 
             */
            const tabEntete = entete.split(";");
            
            //cLe tableau d'objets JSON dans lequel on va mettre chaque objet JSON
            var jsonObjects = [];

            /*Iteration sur chaque ligne à partir de la deuxième, car la première ligne est l'entête
             * Les lignes à  partir de la deuxième correspond à un objet JSON
             */
            for(k=1 ; k<lines.length; k++) {
                //On crée un tableau avec chaque mot separé par des ";"
                values = (lines[k]).split(";");

                ///Création de l'objet JSON
                var jsonObject = {};

                //Parcours de chaque colonne de l'entête pour mettre les les données
                for (let i = 0; i < tabEntete.length; i += 1) {
                    var key = (tabEntete[i].trim()); //Suppression des espaces superflux éventuel avant et après avec trim 
                    
                    /* Formatage de la clé en enlevant des espaces (Ex: First name devient Firstname)
                     * cela est obligatoire car c'est le attribut de l'objet. Pour recuperer une valeur par
                     * exemple on ne peut faire "object.First name" avec un espace entre First et name
                     */
                    key = key.replace(/\s/g, '');
                    const value = values[i].trim();  //Suppression des espaces superflux éventuel avant et après

                    //Ajout de la clé et de la valeur à l'objet JSON (Ex: )
                    jsonObject[key] = value;
                }

                //Ajout de l'objet JSON au tableau d'objet
                jsonObjects.push(jsonObject);
            }

            //Q2-c: chaine de caractère avec les infos pour html
            var nbElem = jsonObjects.length;
            //Boucle sur les éléments et récupération du résultat dans une variable vRes
		    var vRes = " ";
		    for (var i = 0; i < nbElem; ++i ) { 	
                vRes = vRes + jsonObjects[i].Firstname + "  ,  " + jsonObjects[i].Lastname + " ,  " 
                + jsonObjects[i].Identifier + " , " + jsonObjects[i].Username  + "<br/>";   	
		  	}
            
		    //Q2-d: Affichage du resultat au niveau du paragraphe avec l'id "myp"
  			document.getElementById("myp").innerHTML = vRes;
        };
    }
    </script>
</body>
</html>
