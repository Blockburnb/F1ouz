<!doctype html>
 <html lang="fr">
 <head>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 <head>
 <style type="text/css">

 body{
  font-family:Verdana, Geneva, sans-serif;
  background-color:#b2bdc6;
 } 
 
 table {
  border:3px solid #6495ed;
  border-collapse:collapse;
  width:50%;
  margin:auto;
 }

 tbody {
  background-color:#FFFFFF;
  border:1px solid #6495ed;
 }

 th {
  padding:5px;
  background-color:#EFF6FF;
  width:25%;
 }
 td{
  font-family:sans-serif;
  font-size:80%;
  border:1px solid #6495ed;
  padding:5px;
  text-align:center;
 }

 </style>
 
 <script>

function rest(){
    //Récupération de la valeur du département recherché dans la l'élément Id = departement
    var departement=document.getElementById('departement').value
    //Mettre dans une variable l'URL du site avec les données, intégrer la valeur de département dans l'URL
    var adresse='https://geo.api.gouv.fr/departements/'+departement+'/communes'
    alert(adresse)
    //Créer l'objet XMLHttpRequest
    vRequete = new XMLHttpRequest();
    //Utiliser l'événement .onreadystatechange pour lancer la fonction gestion_requete à chaque changement d'état de l'objet XMLHttpRequest 
    vRequete.onreadystatechange = gestion_requete;
    //Ouvrir la requête avec la méthode .open('GET', URL)
    vRequete.open('GET', adresse);
    //Lancer la requête avec la méthode .send()
    vRequete.send();
}

  //Définition de la fonction qui s'exécute quand l'état de l'objet XMLHttpRequest change
  function gestion_requete() {
    //console.log(vRequete.readyState)
    console.log(XMLHttpRequest.DONE)
    //Comparer l'état de la requête avec la propriété .readystate, le comparer avec XMLHttpRequest.DONE
    if (vRequete.readyState === XMLHttpRequest.DONE) {
      //Test le status de la requête, si 200 --> OK, si 404 --> problème
      if (vRequete.status === 200) {
      // récupération de la réponse à la requête (les données) dans une variable
      var donne=vRequete.responseText;
      // transformer cette variable en objet Json avec la méthode .parse()
      donnees=JSON.parse(donne)
      // tri les données de la réponse par ordre décroissant de population
      donnees.sort(function(key1,key2){return key1.population < key2.population;} )
      //insérer les données dans le tableau <tbody> dont l'Id = "rendu" de la page web (DOM)
      document.getElementById("rendu").innerHTML=''
      var popu_globale=0
      //boucle sur l'objet Json issu du parse (contenant tous les objets de la réponse à la requête)
      for ( var i = 0 ; i < donnees.length ; i++) {
       // faire un test pour n'afficher que les communes dont la population est supérieur à 3000 habitants
       if (donnees[i].population > 3000) {
        //insérer une nouvelle ligne dans la table avec la méthode .insertRow(-1), le paramètre -1 est optionnel, il veut dire par défaut que la ligne se rajoute à la fin
        var nouvelleLigne = document.getElementById("rendu").insertRow(-1);
        //insérer une première cellule dans la ligne
        var nouvelleCellule = nouvelleLigne.insertCell(-1);
        //intégrer le nom de la commune dans cette cellule
        nouvelleCellule.textContent=donnees[i].nom
        //insérer une seconde cellule dans la ligne
        nouvelleCellule = nouvelleLigne.insertCell(-1);
        //intégrer le numéro de la commune dans cette cellule (compteur qui démarre à 1), on utilise textContent = i+1
        nouvelleCellule.textContent=i+1
        //insérer une troisième cellule dans la ligne
        nouvelleCellule = nouvelleLigne.insertCell(-1);
        //intégrer le code postal de la commune dans cette cellule
        nouvelleCellule.textContent=donnees[i].codesPostaux
        //insérer une quatrième cellule dans la ligne
        nouvelleCellule = nouvelleLigne.insertCell(-1);
        //intégrer la population
        nouvelleCellule.textContent=donnees[i].population
     }
    //incrémenter une variable population globale avec chaque popoulation de chaque commune
    popu_globale+=donnees[i].population

   }
   //écrire la valeur de population globale dans la balise input texte dont l'Id = "popu_globale"
   document.getElementById("popu_globale").value=popu_globale

}
   else {
        alert('problème de requête.');
      }
    }
  }

</script>
</head>
<body>
 
 <button onclick="rest()">API population</button>
 <input type ="text" id="departement" placeholder="numero departement"/>
 <br>
 <input type ="text"  id='popu_globale'/>
 
 <table>
    <thead>
        <tr>
            <th>ville</th>
   <th>classement</th>
   <th>code postaux</th>
   <th>population</th>
        </tr>
    </thead>
    <tbody id="rendu">
        
    </tbody>
</table>

</body>